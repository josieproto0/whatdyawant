<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends' Wishlists - Whatdyawant?</title>
    <!-- Supabase JS CDN, place this before your own scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>  
    <script src="supabase.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üéÅ</div>
                <h1>Whatdyawant?</h1>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span>üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="my-wishlist.html" class="nav-item">
                <span>‚ù§Ô∏è</span>
                <span>My Wishlist</span>
            </a>
            <a href="friends-wishlists.html" class="nav-item active">
                <span>üë•</span>
                <span>Friends' Wishlists</span>
            </a>
            <a href="shopping-list.html" class="nav-item">
                <span>üõçÔ∏è</span>
                <span>My Shopping List</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-email" id="userEmail">user@email.com</div>
                </div>
            </div>
            <div class="footer-buttons">
                <a href="settings.html" class="btn-small">‚öôÔ∏è Settings</a>
                <button class="btn-small" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h2>Friends' Wishlists üë•</h2>
            <p>Search for your friends by username and save their wishlists to find the perfect gifts!</p>
        </div>

        <!-- Add Friend by Username Section -->
        <div class="add-section">
            <h3>Add Friend by Username</h3>
            <form class="add-form" id="addFriendForm" autocomplete="off">
                <input 
                    type="text" 
                    id="friendUsername" 
                    placeholder="Enter friend's username (case-insensitive)" 
                    required
                    pattern="[a-zA-Z0-9_]+"
                    minlength="3"
                >
                <button type="submit" class="btn btn-primary">üíæ Save Friend</button>
            </form>
        </div>

        <!-- Friends Grid -->
        <div id="friendsContainer"></div>
    </main>

    <script>
    let savedFriends = [];
    let myUsername = "";

    window.addEventListener('DOMContentLoaded', async function() {
        // Get logged in user from Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        const userMeta = user.user_metadata || {};
        document.getElementById('userName').textContent = userMeta.fullName || user.email.split('@')[0];
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = (userMeta.fullName || user.email)[0].toUpperCase();

        // Get your own username for checks
        const { data: myProfile } = await supabase
            .from('profiles')
            .select('username')
            .eq('id', user.id)
            .single();
        myUsername = myProfile?.username?.toLowerCase() || "";

        savedFriends = await loadFriendsFromSupabase();
        await renderFriends();
    });

    async function getCurrentUserId() {
        const { data: { user } } = await supabase.auth.getUser();
        return user ? user.id : null;
    }

    // Save a friend's wishlist to Supabase (now saving user_id and username)
    async function saveFriendToSupabase(friendUserId, friendUsername, friendName) {
        const userId = await getCurrentUserId();
        if (!userId) return;

        const { error } = await supabase
            .from('saved_friends')
            .insert([
                {
                    user_id: userId,
                    friend_user_id: friendUserId,
                    friend_username: friendUsername.toLowerCase(),
                    friend_url: '', // Not used with username search
                    friend_name: friendName
                }
            ]);
        if (error) {
            alert('Error saving friend: ' + error.message);
        }
    }

    // Load saved friends from Supabase (fetch friend_user_id too!)
    async function loadFriendsFromSupabase() {
        const userId = await getCurrentUserId();
        if (!userId) return [];

        const { data, error } = await supabase
            .from('saved_friends')
            .select('friend_user_id, friend_username, friend_url, friend_name')
            .eq('user_id', userId);

        if (error) {
            alert('Error loading friends: ' + error.message);
            return [];
        }
        return data || [];
    }

    // Remove a saved friend from Supabase
    async function removeFriendFromSupabase(friendUserId) {
        const userId = await getCurrentUserId();
        if (!userId) return;

        const { error } = await supabase
            .from('saved_friends')
            .delete()
            .eq('user_id', userId)
            .eq('friend_user_id', friendUserId);

        if (error) {
            alert('Error removing friend: ' + error.message);
        }
    }

    // Render friends (no stats)
    async function renderFriends() {
        const container = document.getElementById('friendsContainer');
        if (savedFriends.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <h3>No saved wishlists yet</h3>
                    <p>Search for a friend's username above to start finding the perfect gifts for them!</p>
                </div>
            `;
            return;
        }

        // Fetch latest profiles for all friend_user_ids
        const friendIds = savedFriends.map(f => f.friend_user_id).filter(Boolean);
        let friendProfiles = [];
        if (friendIds.length > 0) {
            const { data: profilesData, error: profilesError } = await supabase
                .from('profiles')
                .select('id, username, full_name')
                .in('id', friendIds);
            friendProfiles = profilesData || [];
        }

        const friendsList = savedFriends.map((friend, index) => {
            const profile = friendProfiles.find(p => p.id === friend.friend_user_id);
            let username = profile ? profile.username : friend.friend_username;
            let fullName = profile ? profile.full_name : friend.friend_name;
            let isMe = username.toLowerCase() === myUsername;
            return `
                <div class="friend-card">
                    <div class="friend-header">
                        <div class="friend-avatar">${fullName[0].toUpperCase()}</div>
                        <div class="friend-info">
                            <div class="friend-name">${fullName}</div>
                            <div class="friend-username">@${username}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-secondary" onclick="removeFriend('${friend.friend_user_id}')">Remove</button>
                        ${
                            !isMe
                            ? `<a href="wishlist-view.html?friend=${encodeURIComponent(username)}" class="btn-view">
                                View Wishlist ‚Üí
                            </a>`
                            : `<span style="color:#aaa; font-size:13px; flex:2; text-align:center; padding:12px 0;">(That's you!)</span>`
                        }
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = `<div class="friends-grid">${friendsList}</div>`;
    }

    // Add friend form submission (username search)
    document.getElementById('addFriendForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const usernameInput = document.getElementById('friendUsername').value.trim().toLowerCase();
        if (!usernameInput) {
            alert("Please enter a username.");
            return;
        }

        // Get your own username
        if (usernameInput === myUsername) {
            alert("You can't add yourself as a friend!");
            return;
        }

        // Check if user exists
        const { data: friendProfile } = await supabase
            .from('profiles')
            .select('id, username, full_name')
            .ilike('username', usernameInput)
            .single();

        if (!friendProfile) {
            alert("That username doesn't exist.");
            return;
        }

        // Check if already saved
        if (savedFriends.some(f => f.friend_user_id === friendProfile.id)) {
            alert('You already have this friend saved!');
            return;
        }

        // Save to Supabase (using id and username)
        await saveFriendToSupabase(friendProfile.id, friendProfile.username, friendProfile.full_name || friendProfile.username);
        savedFriends = await loadFriendsFromSupabase();
        document.getElementById('friendUsername').value = '';
        await renderFriends();
        alert(`‚úì ${friendProfile.full_name || friendProfile.username}'s wishlist has been saved!`);
    });

    // Remove friend (by user id)
    async function removeFriend(userId) {
        const friendProfile = savedFriends.find(f => f.friend_user_id === userId);
        const friendName = friendProfile?.friend_name || '';
        if (confirm(`Remove ${friendName.charAt(0).toUpperCase() + friendName.slice(1)}'s wishlist?`)) {
            await removeFriendFromSupabase(userId);
            savedFriends = await loadFriendsFromSupabase();
            await renderFriends();
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    async function logout() {
        if (confirm('Are you sure you want to logout?')) {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    }

    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.querySelector('.mobile-menu-btn');
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });
    </script>
</body>
</html>