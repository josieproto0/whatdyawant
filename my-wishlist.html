<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wishlist - Whatdyawant?</title>
    <!-- Supabase JS CDN, place this before your own scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="supabase.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üéÅ</div>
                <h1>Whatdyawant?</h1>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span>üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="my-wishlist.html" class="nav-item active">
                <span>‚ù§Ô∏è</span>
                <span>My Wishlist</span>
            </a>
            <a href="friends-wishlists.html" class="nav-item">
                <span>üë•</span>
                <span>Friends' Wishlists</span>
            </a>
            <a href="shopping-list.html" class="nav-item">
                <span>üõçÔ∏è</span>
                <span>My Shopping List</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-email" id="userEmail">user@email.com</div>
                </div>
            </div>
            <div class="footer-buttons">
                <a href="settings.html" class="btn-small">‚öôÔ∏è Settings</a>
                <button class="btn-small" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h2>My Wishlist ‚ú®</h2>
                <p>Add, edit, and manage the items you'd love to receive</p>
            </div>
            <div></div>
            <button class="btn btn-secondary"
             onclick="openBulkUploadModal()">
                üì¶ Bulk Upload
            </button> 
            <button class="btn btn-primary" onclick="openAddModal()">
                ‚ûï Add Item
            </button>
            </div>
        </div>
                <!-- INSERT the following HTML filter controls into the <main class="main-content"> area,
            ideally right under .page-header (place it before the wishlist grid / container) -->
        <div class="filters-bar" style="display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap;">
        <label style="font-size:14px;color:#374151;margin-left: 8px;">
            Category:
            <select id="filterPriority" style="margin-left:8px;padding:8px;border-radius:6px;border:1px solid #e5e7eb;width: 120px;" >
            <option value="all">All</option>
            <option value="must-have">Must Have</option>
            <option value="would-love">Would Love</option>
            <option value="nice-to-have">Nice to Have</option>
            </select>
        </label>
        

        <label style="font-size:14px;color:#374151;margin-left: 8px;">
            Min Price:
            <input id="filterMinPrice" type="number" step="0.01" min="0" placeholder="0" style="width:120px;margin-left:8px;padding:8px;border-radius:6px;border:1px solid #e5e7eb;">
        </label>

        <label style="font-size:14px;color:#374151;margin-left: 8px;">
            Max Price:
            <input id="filterMaxPrice" type="number" step="0.01" min="0" placeholder="Any" style="width:120px;margin-left:8px;padding:8px;border-radius:6px;border:1px solid #e5e7eb;">
        </label>

        <label style="font-size:14px;color:#374151;margin-left: 8px;">
            Sort:
            <select id="sortBy" style="margin-left:8px;padding:8px;border-radius:6px;border:1px solid #e5e7eb;width: 120px;">
            <option value="default">Default</option>
            <option value="price-asc">Price: Low ‚Üí High</option>
            <option value="price-desc">Price: High ‚Üí Low</option>
            <option value="name-asc">Name: A ‚Üí Z</option>
            <option value="name-desc">Name: Z ‚Üí A</option>
            </select>
        </label>

        <button id="clearFiltersBtn" class="btn btn-secondary" style="margin-left:auto;">Clear</button>
        </div>

        <!-- Wishlist Grid -->
        <div id="wishlistContainer"></div>
    </main>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Item</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>

            <form id="itemForm">
                <div class="form-group">
                    <label for="itemName">Item Name *</label>
                    <input type="text" id="itemName" placeholder="Nintendo Switch" required>
                </div>

                <div class="form-group">
                    <label for="itemPrice">Price</label>
                    <input type="number" id="itemPrice" placeholder="250" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label for="itemLink">Product Link</label>
                    <input type="url" id="itemLink" placeholder="https://amazon.com/...">
                </div>

                <div class="form-group">
                    <label for="itemDescription">Description / Notes</label>
                    <textarea id="itemDescription" placeholder="Any color is fine, or specify preferences..."></textarea>
                </div>

                <div class="form-group">
                    <label for="itemPriority">Priority</label>
                    <select id="itemPriority" required>
                        <option value="nice-to-have">Nice to Have</option>
                        <option value="would-love">Would Love</option>
                        <option value="must-have">Must Have</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Image</label>
                    <div class="image-upload" onclick="document.getElementById('itemImage').click()">
                        <div>üì∑ Click to upload image</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 8px;">Or paste a product URL above to auto-fill</div>
                        <input type="file" id="itemImage" accept="image/*">
                    </div>
                    <div id="imagePreview" class="image-preview" style="display: none;"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Item</button>
                </div>
            </form>
        </div>
    </div>
        <!-- Bulk Upload Modal -->
        <div id="bulkUploadModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
            <h3>Bulk Item Uploader</h3>
            <button class="close-btn" onclick="closeBulkUploadModal()">√ó</button>
            </div>
            <div id="csv-instructions-panel" style="margin-bottom:1.2rem;">
            <h4>How to Prepare a CSV for Bulk Upload</h4>
            <ol>
                <li>Paste your wishlist notes into ChatGPT.</li>
                <li>Use this prompt:
                <pre style="white-space:pre-wrap;background:#f3f4f6;border-radius:6px;padding:8px;">
        Turn the following wishlist notes into a CSV with the following columns:
        name,description,price,link,priority,image_url

        Make sure each item is on its own row, and the first row is the column headers.

        Here are my notes:
        [PASTE YOUR NOTES HERE]

        Output only the CSV, nothing else.
                </pre>
                </li>
                <li>Copy the CSV output into a file and save it as <strong>.csv</strong>.</li>
                <li>Upload your CSV file below and preview before saving!</li>
            </ol>
            <p><strong>Example row:</strong> <code>Nintendo Switch,For gaming,299,https://amazon.com/switch,would-love,https://images.example.com/switch.jpg</code></p>
            </div>
            <input type="file" id="csv-upload" accept=".csv">
            <button id="parse-btn" class="btn btn-secondary" style="margin-bottom:1rem;">Parse & Preview</button>
            <div id="csv-preview" style="margin-bottom:1rem;"></div>
            <button id="upload-btn" class="btn btn-primary" style="display:none;">Upload to Wishlist</button>
            <div id="upload-status" style="margin-top:1rem;color:#15803d;font-weight:600;"></div>
        </div>
        </div>

       <script>
        let wishlistItems = [];
        let editingIndex = -1;
        let userId = null;
        let userCurrency = 'GBP';

        // Load user data and wishlist from Supabase
        window.addEventListener('DOMContentLoaded', async function() {
            // Get the logged in user
            const { data: { user }, error } = await supabase.auth.getUser();

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Get user info from Supabase metadata
            const userMeta = user.user_metadata || {};
            const fullName = userMeta.fullName || user.email.split('@')[0];
            const userEmail = user.email;
            userId = user.id;
            userCurrency = userMeta.currency || 'GBP';

            // Update sidebar UI
            document.getElementById('userName').textContent = fullName;
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('userAvatar').textContent = fullName[0].toUpperCase();

            // Load wishlist items from Supabase
            await loadWishlist();

            // Wire up filters (now that the DOM controls exist)
            attachWishlistFilterHandlers();
        });

        async function loadWishlist() {
            // Fetch items for this user from Supabase
            const { data, error } = await supabase
                .from('wishlist_items')
                .select('*')
                .eq('user_id', userId);

            if (error) {
                alert('Error loading wishlist: ' + error.message);
                wishlistItems = [];
            } else {
                wishlistItems = data || [];
            }
            renderWishlist();
        }

            // ===== Filters state & helpers for my-wishlist.html =====
            let filterPriority = 'all';
            let filterMinPrice = null;
            let filterMaxPrice = null;
            let sortBy = 'default';

            function readFilterInputs() {
            const p = document.getElementById('filterPriority').value;
            const min = document.getElementById('filterMinPrice').value;
            const max = document.getElementById('filterMaxPrice').value;
            const s = document.getElementById('sortBy').value;

            filterPriority = p || 'all';
            filterMinPrice = min !== '' ? parseFloat(min) : null;
            filterMaxPrice = max !== '' ? parseFloat(max) : null;
            sortBy = s || 'default';
            }

            function clearFilters() {
            document.getElementById('filterPriority').value = 'all';
            document.getElementById('filterMinPrice').value = '';
            document.getElementById('filterMaxPrice').value = '';
            document.getElementById('sortBy').value = 'default';
            readFilterInputs();
            renderWishlist(); // re-render
            }

            function applyFiltersToItems(items) {
            // items: array of wishlist items
            let filtered = (items || []).slice();

            // Priority/category filter
            if (filterPriority && filterPriority !== 'all') {
                filtered = filtered.filter(it => (it.priority || '').toLowerCase() === filterPriority.toLowerCase());
            }

            // Price filters
            filtered = filtered.filter(it => {
                const price = it.price !== null && it.price !== undefined && it.price !== '' ? parseFloat(it.price) : null;
                if (filterMinPrice !== null && (price === null || price < filterMinPrice)) return false;
                if (filterMaxPrice !== null && (price === null || price > filterMaxPrice)) return false;
                return true;
            });

            // Sorting
            switch (sortBy) {
                case 'price-asc':
                filtered.sort((a, b) => (parseFloat(a.price || 0) - parseFloat(b.price || 0)));
                break;
                case 'price-desc':
                filtered.sort((a, b) => (parseFloat(b.price || 0) - parseFloat(a.price || 0)));
                break;
                case 'name-asc':
                filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                break;
                case 'name-desc':
                filtered.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
                break;
                case 'default':
                default:
                // keep DB order
            }

            return filtered;
            }

            // Hook up filter input events (call this once after DOM loaded)
            function attachWishlistFilterHandlers() {
            const inputs = ['filterPriority','filterMinPrice','filterMaxPrice','sortBy'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => { readFilterInputs(); renderWishlist(); });
            });
            const clearBtn = document.getElementById('clearFiltersBtn');
            if (clearBtn) clearBtn.addEventListener('click', clearFilters);

            // initialize state
            readFilterInputs();
            }

            // Render Wishlist (uses filteredItems and item ids for actions)
            function renderWishlist() {
                const container = document.getElementById('wishlistContainer');

                // If there are no items at all, show the "Your wishlist awaits" state
                if (!wishlistItems || wishlistItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéÅ</div>
                            <h3>Your wishlist awaits!</h3>
                            <p>Start adding items you'd love to receive. Your friends can claim them without you knowing!</p>
                            <button class="btn btn-primary" onclick="openAddModal()">
                                ‚ûï Add Your First Item
                            </button>
                        </div>
                    `;
                    return;
                }

                // Apply filters
                const filteredItems = applyFiltersToItems(wishlistItems);

                // If filters produce no results, show a helpful empty state
                if (!filteredItems || filteredItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéÅ</div>
                            <h3>No items match your filters</h3>
                            <p>Try clearing or adjusting filters to see more items.</p>
                            <button class="btn btn-primary" onclick="clearFilters()">
                                Clear Filters
                            </button>
                        </div>
                    `;
                    return;
                }

                // Render filtered items. Use stable item.id for menu ids and action handlers.
                container.innerHTML = `<div class="wishlist-grid">${filteredItems.map((item) => `
                    <div class="wishlist-card">
                        <div class="card-image">
                            ${item.image_url ? `<img src="${item.image_url}" alt="${item.name}">` : 'üéÅ'}
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-title">${item.name}</div>
                                <div class="card-menu">
                                    <button class="menu-btn" onclick="toggleMenu(event, '${item.id}')">‚ãÆ</button>
                                    <div class="dropdown-menu" id="menu-${item.id}">
                                        <button class="dropdown-item" onclick="editItemById('${item.id}')">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button class="dropdown-item danger" onclick="deleteItemById('${item.id}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${item.priority ? `<span class="priority-badge priority-${item.priority}">${item.priority.replace('-', ' ').toUpperCase()}</span>` : ''}
                            ${item.price ? `<div class="card-price">${getCurrencySymbol()}${parseFloat(item.price).toFixed(2)}</div>` : ''}
                            ${item.description ? `<div class="card-description">${item.description}</div>` : ''}
                            ${item.link ? `<a href="${item.link}" target="_blank" class="card-link">üîó View Product</a>` : ''}
                        </div>
                    </div>
                `).join('')}</div>`;

                // ensure any open menus are closed if clicking outside (your global handler already does this)
                closeAllMenus();
            }

        function getCurrencySymbol() {
            const symbols = { GBP: '¬£', USD: '$', EUR: '‚Ç¨', NOK: 'kr ', SEK: 'kr ', DKK: 'kr ' };
            return symbols[userCurrency] || '$';
        }

        // toggleMenu now takes an itemId (stable) not an array index
        function toggleMenu(event, itemId) {
            event.stopPropagation();
            const menu = document.getElementById(`menu-${itemId}`);
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            if (menu) menu.classList.toggle('active');
        }

        function openAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Add Item';
            document.getElementById('saveBtn').textContent = 'Save Item';
            document.getElementById('itemForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('itemModal').classList.add('active');
        }

        // original editItem that uses index remains for internal reuse
        function editItem(index) {
            editingIndex = index;
            const item = wishlistItems[index];

            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('saveBtn').textContent = 'Update Item';
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemPrice').value = item.price || '';
            document.getElementById('itemLink').value = item.link || '';
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemPriority').value = item.priority || 'nice-to-have';

            if (item.image_url) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${item.image_url}" alt="Preview">`;
                preview.style.display = 'block';
            }

            document.getElementById('itemModal').classList.add('active');
            closeAllMenus();
        }

        // New wrapper: edit by item id (futureproof)
        function editItemById(itemId) {
            const index = wishlistItems.findIndex(i => i.id === itemId);
            if (index === -1) {
                alert('Item not found.');
                return;
            }
            editItem(index);
        }

        // original deleteItem by index still used internally
        async function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const item = wishlistItems[index];
                // Delete from Supabase
                const { error } = await supabase
                    .from('wishlist_items')
                    .delete()
                    .eq('id', item.id);
                if (error) {
                    alert('Error deleting item: ' + error.message);
                } else {
                    await loadWishlist();
                }
            }
            closeAllMenus();
        }

        // New wrapper: delete by item id (futureproof)
        async function deleteItemById(itemId) {
            const index = wishlistItems.findIndex(i => i.id === itemId);
            if (index === -1) {
                alert('Item not found.');
                return;
            }
            await deleteItem(index);
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            editingIndex = -1;
        }

        function closeAllMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
        }

        // Image upload preview (still local, not stored in Supabase yet)
        document.getElementById('itemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('itemForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const item = {
                user_id: userId,
                name: document.getElementById('itemName').value,
                price: document.getElementById('itemPrice').value,
                link: document.getElementById('itemLink').value,
                description: document.getElementById('itemDescription').value,
                priority: document.getElementById('itemPriority').value,
                image_url: document.querySelector('#imagePreview img')?.src || ''
            };

            if (editingIndex >= 0) {
                // Update in Supabase
                const itemToUpdate = wishlistItems[editingIndex];
                const { error } = await supabase
                    .from('wishlist_items')
                    .update(item)
                    .eq('id', itemToUpdate.id);
                if (error) {
                    alert('Error updating item: ' + error.message);
                }
            } else {
                // Add new item in Supabase
                const { error } = await supabase
                    .from('wishlist_items')
                    .insert([item]);
                if (error) {
                    alert('Error adding item: ' + error.message);
                }
            }

            await loadWishlist();
            closeModal();
        });

                    // Bulk Upload Modal
            function openBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.add('active');
            }
            function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.remove('active');
            }
            // Close modal when clicking outside
            document.getElementById('bulkUploadModal').addEventListener('click', function(e) {
            if (e.target === this) closeBulkUploadModal();
            });

            // CSV Upload Logic
            let parsedItems = [];
            document.getElementById('parse-btn').onclick = function() {
            const fileInput = document.getElementById('csv-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a CSV file.');
                return;
            }
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                parsedItems = results.data;
                showBulkPreview(parsedItems);
                },
                error: function(err) {
                alert('Error parsing CSV: ' + err.message);
                }
            });
            };
            function showBulkPreview(items) {
            const previewDiv = document.getElementById('csv-preview');
            if (!items.length) {
                previewDiv.innerHTML = '<p>No items found in CSV.</p>';
                document.getElementById('upload-btn').style.display = 'none';
                return;
            }
            let html = '<table><tr>';
            for (let key in items[0]) html += `<th>${key}</th>`;
            html += '</tr>';
            items.forEach(item => {
                html += '<tr>';
                for (let key in items[0]) html += `<td>${item[key] || ''}</td>`;
                html += '</tr>';
            });
            html += '</table><p>Check your items above. If all looks good, upload them!</p>';
            previewDiv.innerHTML = html;
            document.getElementById('upload-btn').style.display = '';
            }
            document.getElementById('upload-btn').onclick = async function() {
            if (!parsedItems.length) return alert('No items to upload.');
            document.getElementById('upload-status').style.color = '#222';
            document.getElementById('upload-status').innerText = 'Uploading...';
            // Assumes userId is set from your existing logic
            const itemsToInsert = parsedItems.map(item => ({
                name: item.name,
                description: item.description,
                price: item.price ? Number(item.price) : null,
                link: item.link,
                priority: item.priority,
                image_url: item.image_url,
                user_id: userId
            }));
            const { error } = await supabase
                .from('wishlist_items')
                .insert(itemsToInsert);
            if (error) {
                document.getElementById('upload-status').style.color = '#d90429';
                document.getElementById('upload-status').innerText = 'Upload failed: ' + error.message;
            } else {
                document.getElementById('upload-status').style.color = '#15803d';
                document.getElementById('upload-status').innerText = 'Upload successful!';
                closeBulkUploadModal();
                await loadWishlist(); // Refresh your wishlist view
            }
            };

        // Close modal when clicking outside
        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Close menus when clicking outside
        document.addEventListener('click', closeAllMenus);

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Supabase-based logout
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>